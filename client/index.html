<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>bull-dashboard</title>
    <style>
      /* layout */
      html, body { min-height: 100%; min-height: 100vh; }
      body { padding: 0.5em 1em; }
      body > header { max-width: 45em; margin: 0 auto; }
      body > main { max-width: 45em; margin: 0 auto; }
      body > footer { max-width: 45em; margin: 0 auto; }
      img { max-width: 100%; }

      /* typography */
      html, body { font-size: 22px; font-weight: 400; line-height: 1; }
      @media all and (max-width: 45em) { html, body { font-size: 18px; } }
      html, body { font-family: 'Poppins', sans-serif; }
      a { color: inherit; }
      a:visited { color: inherit; }
      pre, code { overflow: scroll; }
      ul { padding-left: 0em; }
      h1, h2, h3 { margin-top: 0; }
      /* https://type-scale.com/ */
      h1, h2, h3, h4, h5 { margin: 2.75rem 0 1rem; font-weight: 400; line-height: 1.15; }
      h1 { margin-top: 0; font-size: 2.488em; }
      h2 { font-size: 2.074em; }
      h3 { font-size: 1.728em; }
      h4 { font-size: 1.44em; }
      h5 { font-size: 1.2em; }
      small, .text_small { font-size: 0.833em; }
    </style>
    <style>
      h1, h2, h3, h4, h5, h6 {
        margin-top: 0;
      }
      .queue {
        overflow: hidden;
        min-height: 20em;
        box-shadow: 0 1px 3px rgba(0,0,0,.5);
        padding: 0.3em 1em;
        border-radius: 6px;
        margin-bottom: 2em;
      }
      .queue-types div {
        padding: 0.1em;
        overflow: hidden;
      }
      .queue-name {
        text-decoration: underline;
      }
      .queue-details {
        display: flex;
        flex-direction: row;
      }
      .queue-type-name {
        font-weight: bold;
        margin-right: 1em;
      }
      .queue .queue-type-count {
        float: right;
      }
      .queue-type-count {
        border-radius: 50%;
        font-size: 0.75em;
        display: inline-block;
        width: 1.25em;
        height: 1.25em;
        padding: 0.2em;
        background: grey;
        color: white;
        text-align: center;
        line-height: 1.4em;
      }
      .queue-preview {
        flex: 1;
      }
      .queue-preview pre {
        font-size: 1em;
        height: 13em;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <main id="main">
      <h1 id="loading">loading dashboard...</h1>
    </main>

    <script>
      const eventSource = new EventSource('/stream')
      window.eventSource = eventSource
    </script>
    <script type="module">
      import * as preact from 'https://cdn.pika.dev/preact/latest';
      const { Component } = preact

      window.loading.style = 'display: none'


      function humanMS (ms) {
        if (!Number.isFinite(ms)) return ``
        const minutes = ms / (1000 * 60)
        const wholeMinutes = parseInt(minutes, 10)
        const seconds = (minutes - wholeMinutes) * 60
        const wholeSeconds = parseInt(seconds, 10)
        const wholeMillis = parseInt((seconds - wholeSeconds) * 1000, 10)
        let humanString = ``
        if (wholeMinutes > 0) humanString += `${wholeMinutes}m `
        if (wholeSeconds > 0) humanString += `${wholeSeconds}s `
        humanString += `${wholeMillis}ms `
        return humanString
      }

      function Job () {
        Component.constructor.call(this)
        this.state = {
        }
      }
      Job.prototype = Object.create(Component.prototype)
      Job.prototype.render = function () {
        const job = this.props
        console.log(JSON.stringify(job))
        /*
        {
          "id":"5",
          "name":"__default__",
          "data":{},
          "opts":{
            "attempts":1,
            "delay":0,
            "timestamp":1568225801948
          },
          "progress":0,
          "delay":0,
          "timestamp":1568225801948,
          "attemptsMade":0,
          "stacktrace":[],
          "returnvalue":null,
          "finishedOn":1568225802337,
          "processedOn":1568225801949,
          "children":[]
        }
        */
        return preact.h('div', {className: `job ${job.id}`}, [
          preact.h('span', null, `#${job.id}\tattempts: ${job.opts.attempts}\tdelay: ${job.delay}\tprogress: ${job.progress}`),
          preact.h('span', null, `\ttimestamp: ${new Date(job.timestamp).toISOString()}
          \tprocessedOn: ${new Date(job.processedOn).toISOString()}
          \tfinishedOn: ${new Date(job.finishedOn).toISOString()}
          \tduration: ${humanMS(job.finishedOn - job.processedOn)}
          `),
        ].filter(Boolean))
        return null
      }
      function Queue () {
        Component.constructor.call(this)
        this.state = {
          showQueueDetails: undefined
        }
      }
      Queue.prototype = Object.create(Component.prototype)
      Queue.prototype.render = function () {
        const queue = this.props
        if (!queue) return
        function showQueueDetails (name) {
          this.setState({
            showQueueDetails: name
          })
        }
        console.log('-- Queue render')
        return preact.h('div', {className: `queue queue-${queue.name}`}, [
          preact.h('h1', {className: 'queue-name'}, [queue.name]),
          preact.h('div', {className: 'queue-details'}, [
            preact.h('div', {className: 'queue-types'}, [
              preact.h('div', {onClick: showQueueDetails.bind(this, 'active').bind(this)}, [
                preact.h('span', {className: 'queue-type-name'}, ['active']),
                preact.h('span', {className: 'queue-type-count'}, [queue.active.length])
              ]),
              preact.h('div', {onClick: showQueueDetails.bind(this, 'completed').bind(this)}, [
                preact.h('span', {className: 'queue-type-name'}, ['completed']),
                preact.h('span', {className: 'queue-type-count'}, [queue.completed.length])
              ]),
              preact.h('div', {onClick: showQueueDetails.bind(this, 'failed').bind(this)}, [
                preact.h('span', {className: 'queue-type-name'}, ['failed']),
                preact.h('span', {className: 'queue-type-count'}, [queue.failed.length])
              ]),
              preact.h('div', {onClick: showQueueDetails.bind(this, 'waiting').bind(this)}, [
                preact.h('span', {className: 'queue-type-name'}, ['waiting']),
                preact.h('span', {className: 'queue-type-count'}, [queue.waiting.length])
              ]),
              preact.h('div', {onClick: showQueueDetails.bind(this, 'delayed').bind(this)}, [
                preact.h('span', {className: 'queue-type-name'}, ['delayed']),
                preact.h('span', {className: 'queue-type-count'}, [queue.delayed.length])
              ])
            ]),
            preact.h('div', {className: 'queue-preview'}, this.state.showQueueDetails ? [
              preact.h('h3', {className: ''}, [
                this.state.showQueueDetails
              ]),
              preact.h('ul', {className: ''}, queue[this.state.showQueueDetails].map(job => preact.h(Job, job))),
              preact.h('pre', {className: ''}, [
                JSON.stringify(queue[this.state.showQueueDetails], null, 2)
              ])
            ] : null)
          ])
        ])
      }

      function App () {
        Component.constructor.call(this)
        this.state = {data: []}
        eventSource.onmessage = (message) => {
          if (!message || !message.data) return console.error('skipping empty message')
          const data = JSON.parse(message.data)
          this.setState({data})
        }
      }
      App.prototype = Object.create(Component.prototype)
      App.prototype.shouldComponentUpdate =  function  (nextProps, nextState) {
        const shouldAppUpdate = JSON.stringify(this.state) !== JSON.stringify(nextState)
        shouldAppUpdate && console.log({shouldAppUpdate})
        return shouldAppUpdate
      }
      App.prototype.render = function () {
        const layout = this.state.data.map((queue) => preact.h(Queue, queue))
        return preact.h('div', null, layout)
      }
      preact.render(preact.h(App), document.getElementById('main'))
    </script>

  </body>
</html>